rules_version = '2';

function isAdmin() {
  return request.auth != null
      && request.auth.token.email == "admin@tablebites.com";
}

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /restaurants/{restaurantId} {
      
      // Rule for querying the 'orders' collection.
      // This allows admins to list orders, specifically when filtering by 'status'.
      match /orders/{orderId} {
        allow list: if isAdmin() && request.query.keys().hasOnly(['status']);

        // Rule for accessing a single order document.
        allow read, write: if isAdmin();

        // Allow any authenticated user (including anonymous) to create an order.
        allow create: if request.auth != null;
      }
    }
  }
}
